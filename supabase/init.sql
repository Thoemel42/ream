create role anon nologin;
create role authenticated nologin;
create role service_role nologin bypassrls;
create role authenticator noinherit login password 'authenticator';

grant anon to authenticator;
grant authenticated to authenticator;
grant service_role to authenticator;

drop table if exists public.todos;
drop table if exists public.user_roles;
drop table if exists public.role_categories;
drop table if exists public.resource_categories;
drop table if exists public.resource_roles;
drop table if exists public.resources;
drop table if exists public.roles;
drop table if exists public.categories;
drop table if exists public.users;
drop type if exists public.resource_type;

create table if not exists public.users (
  email text primary key,
  username text not null unique,
  password_hash text not null
);

create table if not exists public.roles (
  id bigint generated by default as identity primary key,
  name text not null unique
);

create table if not exists public.categories (
  id bigint generated by default as identity primary key,
  name text not null unique
);

create table if not exists public.user_roles (
  user_email text not null references public.users (email) on delete cascade,
  role_id bigint not null references public.roles (id) on delete cascade,
  primary key (user_email, role_id)
);

create table if not exists public.role_categories (
  role_id bigint not null references public.roles (id) on delete cascade,
  category_id bigint not null references public.categories (id) on delete cascade,
  primary key (role_id, category_id)
);

create type public.resource_type as enum ('link', 'text');

create table if not exists public.resources (
  id bigint generated by default as identity primary key,
  title text not null,
  type public.resource_type not null,
  content text not null,
  created_by_email text not null references public.users (email)
);

create table if not exists public.resource_roles (
  resource_id bigint not null references public.resources (id) on delete cascade,
  role_id bigint not null references public.roles (id) on delete cascade,
  primary key (resource_id, role_id)
);

create table if not exists public.resource_categories (
  resource_id bigint not null references public.resources (id) on delete cascade,
  category_id bigint not null references public.categories (id) on delete cascade,
  primary key (resource_id, category_id)
);

insert into public.users (email, username, password_hash)
values
  ('admin@example.com', 'admin', '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9'),
  ('editor@example.com', 'editor', 'ef5e5a1fb95055e0e56cccf98a41e784a132c14e7f6e1ba244302f0e72b29baf'),
  ('reader@example.com', 'reader', '128a1cb71e153e042708de7ea043d9a030fc1a83fa258788e7ef7aa23309eb72');

insert into public.roles (name)
values
  ('admin'),
  ('editor'),
  ('reader');

insert into public.categories (name)
values
  ('Dokumentation'),
  ('Tools'),
  ('Guides');

insert into public.user_roles (user_email, role_id)
values
  ('admin@example.com', 1),
  ('admin@example.com', 2),
  ('editor@example.com', 2),
  ('reader@example.com', 3);

insert into public.role_categories (role_id, category_id)
values
  (1, 1),
  (1, 2),
  (1, 3),
  (2, 1),
  (2, 2),
  (3, 1);

insert into public.resources (title, type, content, created_by_email)
values
  ('Astro Doku', 'link', 'https://astro.build', 'admin@example.com'),
  ('Supabase Docs', 'link', 'https://supabase.com/docs', 'editor@example.com'),
  ('Interne Setup Notiz', 'text', 'Interne Notiz: Setup fuer lokales PostgREST laeuft.', 'reader@example.com');

insert into public.resource_roles (resource_id, role_id)
values
  (1, 1),
  (1, 2),
  (2, 2),
  (3, 3);

insert into public.resource_categories (resource_id, category_id)
values
  (1, 1),
  (2, 2),
  (3, 1);

grant usage on schema public to anon, authenticated, service_role;
grant select, insert, update, delete on all tables in schema public to anon, authenticated, service_role;
grant usage, select on all sequences in schema public to anon, authenticated, service_role;

alter default privileges in schema public
  grant select, insert, update, delete on tables to anon, authenticated, service_role;
alter default privileges in schema public
  grant usage, select on sequences to anon, authenticated, service_role;
